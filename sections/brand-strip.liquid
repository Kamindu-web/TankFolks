{% comment %}
  File: sections/brand-strip.liquid
  Brand logos carousel powered by Swiper (looping, responsive, autoplay).
  Robust loading + cloning to guarantee motion even with few slides.
{% endcomment %}

<section class="brand-strip" data-section-id="{{ section.id }}" style="background: {{ section.settings.bg }}">
    <style>
      #bs-wrap-{{ section.id }}{
        max-width: {% if section.settings.full_width %}none{% else %}{{ section.settings.max_width }}px{% endif %};
        margin: 0 auto;
        padding: {{ section.settings.v_pad }}px {% if section.settings.full_width %}0{% else %}16px{% endif %};
        box-sizing: border-box;
      }
  
      /* Swiper sizing */
      #bs-swiper-{{ section.id }} { width: 100%; }
      #bs-swiper-{{ section.id }} .swiper-slide { display:flex; align-items:center; justify-content:center; }
      #bs-swiper-{{ section.id }} .bs-link { display:inline-flex; align-items:center; justify-content:center; text-decoration:none; }
  
      /* logo image */
      #bs-swiper-{{ section.id }} .bs-img{
        height: {{ section.settings.logo_height }}px; width:auto; max-width: 180px; object-fit:contain; display:block;
        {% if section.settings.grayscale %} filter: grayscale(1); opacity:.85; {% endif %}
        transition: opacity .2s ease, filter .2s ease, transform .2s ease;
      }
      #bs-swiper-{{ section.id }} .swiper-slide:hover .bs-img{
        {% if section.settings.grayscale %} filter:none; opacity:1; {% else %} opacity:1; {% endif %}
        transform: translateY(-1px);
      }
  
      /* arrows */
      #bs-wrap-{{ section.id }} .swiper-button-prev,
      #bs-wrap-{{ section.id }} .swiper-button-next{
        width:36px; height:36px; border-radius:999px; background:#fff; border:1px solid #e5e7eb; color:#111;
        box-shadow:0 2px 8px rgba(0,0,0,.08);
      }
      #bs-wrap-{{ section.id }} .swiper-button-prev:after,
      #bs-wrap-{{ section.id }} .swiper-button-next:after{ font-size:16px; }
      {% unless section.settings.show_arrows %}
        #bs-wrap-{{ section.id }} .swiper-button-prev,
        #bs-wrap-{{ section.id }} .swiper-button-next{ display:none; }
      {% endunless %}
  
      /* dots */
      #bs-wrap-{{ section.id }} .swiper-pagination-bullets{ margin-top:10px; position:static; }
      #bs-wrap-{{ section.id }} .swiper-pagination-bullet{ width:8px; height:8px; background:#cfd3d9; opacity:1; }
      #bs-wrap-{{ section.id }} .swiper-pagination-bullet-active{ background:#ff5a1f; }
      {% unless section.settings.show_dots %}
        #bs-wrap-{{ section.id }} .swiper-pagination{ display:none; }
      {% endunless %}
    </style>
  
    {%- comment -%} Count logos and cap by max_items {%- endcomment -%}
    {% assign bs_count = 0 %}
    {% for block in section.blocks %}
      {% if block.type == 'logo' and block.settings.logo != blank %}
        {% assign bs_count = bs_count | plus: 1 %}
      {% endif %}
    {% endfor %}
    {% if section.settings.max_items > 0 and section.settings.max_items < bs_count %}
      {% assign bs_count = section.settings.max_items %}
    {% endif %}
  
    <div id="bs-wrap-{{ section.id }}">
      <div id="bs-swiper-{{ section.id }}" class="swiper">
        <div class="swiper-wrapper">
          {%- assign shown = 0 -%}
          {%- for block in section.blocks -%}
            {%- if block.type == 'logo' and block.settings.logo != blank -%}
              {%- if section.settings.max_items == 0 or shown < section.settings.max_items -%}
                <div class="swiper-slide" {{ block.shopify_attributes }}>
                  {%- if block.settings.url != blank -%}
                    <a class="bs-link" href="{{ block.settings.url }}" aria-label="{{ block.settings.alt | escape }}">
                      <img class="bs-img" src="{{ block.settings.logo | image_url }}" alt="{{ block.settings.alt | escape }}">
                    </a>
                  {%- else -%}
                    <img class="bs-img" src="{{ block.settings.logo | image_url }}" alt="{{ block.settings.alt | escape }}">
                  {%- endif -%}
                </div>
                {%- assign shown = shown | plus: 1 -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        </div>
  
        {% if section.settings.show_arrows %}
          <div class="swiper-button-prev"></div>
          <div class="swiper-button-next"></div>
        {% endif %}
        {% if section.settings.show_dots %}
          <div class="swiper-pagination"></div>
        {% endif %}
      </div>
    </div>
  
    {%- comment -%} Swiper assets (load once globally) {%- endcomment -%}
    <link id="swiper-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css">
    <script>
      (function ensureSwiper(){
        if(window.Swiper){ window.dispatchEvent(new CustomEvent('bs-swiper-ready')); return; }
        if(document.getElementById('swiper-js')) return;
        var s=document.createElement('script');
        s.id='swiper-js'; s.src='https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js';
        s.onload=function(){ window.dispatchEvent(new CustomEvent('bs-swiper-ready')); };
        document.head.appendChild(s);
      })();
    </script>
  
    <script>
      (function(){
        var id = "{{ section.id }}";
        var container = document.getElementById("bs-swiper-"+id);
        if(!container) return;
  
        function init(){
          if(!window.Swiper) return;
  
          // --- Guarantee loopability by cloning if needed ---
          var wrapper = container.querySelector(".swiper-wrapper");
          var slides  = Array.from(wrapper.children);
          var total   = slides.length;
          var perDesktop = {{ section.settings.per_desktop }};
          var needForLoop = perDesktop + 1; // Swiper needs > slidesPerView for true loop
  
          if({{ section.settings.loop | json }} && total > 0 && total < needForLoop){
            // clone until we have at least slidesPerView+1
            var idx = 0;
            while(wrapper.children.length < needForLoop){
              var clone = slides[idx % total].cloneNode(true);
              clone.classList.add("bs-clone");
              wrapper.appendChild(clone);
              idx++;
            }
          }
  
          // If still only 1 slide, disable interactions
          var onlyOne = wrapper.children.length <= 1;
  
          var swiper = new Swiper(container, {
            loop: {{ section.settings.loop | json }} && !onlyOne,
            speed: {{ section.settings.transition_ms | default: 350 }},
            spaceBetween: {{ section.settings.gap }},
            slidesPerView: {{ section.settings.per_desktop }},
            allowTouchMove: !onlyOne,
            watchOverflow: true,          // prevents weirdness when not enough slides
            observeParents: true,
            observer: true,
  
            autoplay: {% if section.settings.autoplay %}{ delay: {{ section.settings.autoplay_ms }}, disableOnInteraction:false, pauseOnMouseEnter:true }{% else %}false{% endif %},
  
            navigation: {
              nextEl: '#bs-wrap-{{ section.id }} .swiper-button-next',
              prevEl: '#bs-wrap-{{ section.id }} .swiper-button-prev'
            },
            pagination: {
              el: '#bs-wrap-{{ section.id }} .swiper-pagination',
              clickable: true
            },
  
            breakpoints: {
              0:   { slidesPerView: {{ section.settings.per_mobile }} },
              641: { slidesPerView: {{ section.settings.per_tablet }} },
              991: { slidesPerView: {{ section.settings.per_desktop }} }
            }
          });
        }
  
        if(window.Swiper) { init(); }
        else { window.addEventListener('bs-swiper-ready', init, { once:true }); }
      })();
    </script>
  </section>
  
  {% schema %}
  {
    "name": "Brand Logos (Carousel)",
    "enabled_on": { "templates": ["*"] },
    "settings": [
      { "type": "checkbox", "id": "full_width", "label": "Full width", "default": false },
      { "type": "range", "id": "max_width", "min": 960, "max": 1600, "step": 20, "label": "Content max width (px)", "default": 1200 },
  
      { "type": "color", "id": "bg", "label": "Background", "default": "#ffffff" },
      { "type": "range", "id": "v_pad", "min": 0, "max": 60, "step": 2, "label": "Vertical padding (px)", "default": 14 },
      { "type": "range", "id": "logo_height", "min": 20, "max": 80, "step": 2, "label": "Logo height (px)", "default": 34 },
      { "type": "range", "id": "gap", "min": 8, "max": 60, "step": 2, "label": "Gap between logos (px)", "default": 36 },
      { "type": "checkbox", "id": "grayscale", "label": "Grayscale (color on hover)", "default": false },
  
      { "type": "range", "id": "max_items", "min": 0, "max": 100, "step": 1, "label": "Max logos to show (0 = all)", "default": 0 },
  
      { "type": "header", "content": "Carousel options" },
      { "type": "range", "id": "per_desktop", "min": 2, "max": 12, "step": 1, "label": "Logos per view (desktop)", "default": 8 },
      { "type": "range", "id": "per_tablet", "min": 2, "max": 10, "step": 1, "label": "Logos per view (tablet)",  "default": 5 },
      { "type": "range", "id": "per_mobile", "min": 1, "max": 6,  "step": 1, "label": "Logos per view (mobile)",  "default": 3 },
  
      { "type": "checkbox", "id": "show_arrows", "label": "Show arrows", "default": true },
      { "type": "checkbox", "id": "show_dots", "label": "Show dots", "default": false },
      { "type": "checkbox", "id": "loop", "label": "Loop", "default": true },
      { "type": "checkbox", "id": "autoplay", "label": "Autoplay", "default": true },
      { "type": "range", "id": "autoplay_ms", "min": 2000, "max": 9000, "step": 500, "label": "Autoplay interval (ms)", "default": 5000 },
      { "type": "range", "id": "transition_ms", "min": 150, "max": 1000, "step": 50, "label": "Transition speed (ms)", "default": 350 }
    ],
    "blocks": [
      {
        "type": "logo",
        "name": "Logo",
        "settings": [
          { "type": "image_picker", "id": "logo", "label": "Logo image (SVG/PNG)" },
          { "type": "text", "id": "alt", "label": "Alt text", "default": "Brand logo" },
          { "type": "url", "id": "url", "label": "Optional link" }
        ]
      }
    ],
    "presets": [{ "name": "Brand Logos (Carousel)", "category": "Custom" }]
  }
  {% endschema %}
  